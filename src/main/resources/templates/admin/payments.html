<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Notifications - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm">
                <div class="flex items-center justify-between p-4">
                    <h1 class="text-2xl font-semibold text-gray-800">Payment Notifications</h1>
                    <div class="flex items-center space-x-4">
                        <div id="connectionStatus" class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                            <span class="text-sm text-gray-600">Disconnected</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Real-time Booking Notifications</h2>
                    
                    <!-- Notification List -->
                    <div id="notificationList" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-bell text-4xl mb-2"></i>
                            <p>Waiting for new booking notifications...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let stompClient = null;
        const notificationList = document.getElementById('notificationList');
        const statusIndicator = document.getElementById('connectionStatus');

        function updateConnectionStatus(connected) {
            const dot = statusIndicator.querySelector('.w-3');
            const text = statusIndicator.querySelector('.text-sm');
            
            if (connected) {
                dot.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                text.textContent = 'Connected';
                text.className = 'text-sm text-green-600';
            } else {
                dot.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                text.textContent = 'Disconnected';
                text.className = 'text-sm text-red-600';
            }
        }

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                updateConnectionStatus(true);
                
                stompClient.subscribe('/topic/admin/bookings', function(notification) {
                    showNotification(JSON.parse(notification.body));
                });
            }, function(error) {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
                setTimeout(connect, 5000); // Reconnect after 5 seconds
            });
        }

        function showNotification(data) {
            // Remove "waiting" message if exists
            const waitingMsg = notificationList.querySelector('.text-gray-500');
            if (waitingMsg) {
                waitingMsg.remove();
            }

            const notificationElement = document.createElement('div');
            notificationElement.className = 'bg-green-50 border-l-4 border-green-500 p-4 rounded-lg notification-item';
            notificationElement.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-lg font-semibold text-green-800">${data.message}</h3>
                        <div class="mt-2 text-sm text-gray-700 space-y-1">
                            <p><strong>Booking Code:</strong> ${data.bookingCode}</p>
                            <p><strong>Customer:</strong> ${data.customerName} (${data.customerEmail})</p>
                            <p><strong>Tour:</strong> ${data.tourName}</p>
                            <p><strong>Amount:</strong> $${data.amount}</p>
                            <p><strong>Payment Date:</strong> ${new Date(data.paymentDate).toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="ml-4">
                        <button onclick="this.closest('.notification-item').remove()" 
                                class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            notificationList.insertBefore(notificationElement, notificationList.firstChild);
            
            // Play notification sound (optional)
            playNotificationSound();
            
            // Show browser notification if permitted
            if (Notification.permission === 'granted') {
                new Notification('New Booking Payment', {
                    body: `${data.customerName} paid $${data.amount} for ${data.tourName}`,
                    icon: '/favicon.ico'
                });
            }
        }

        function playNotificationSound() {
            // You can add an audio element to play a notification sound
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCZxxvDTgjMGHm7A7+OZGQ==');
            audio.play().catch(e => console.log('Could not play sound'));
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Connect on page load
        window.addEventListener('load', connect);

        // Disconnect on page unload
        window.addEventListener('beforeunload', function() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
        });
    </script>
</body>
</html>
